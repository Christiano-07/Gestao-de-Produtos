<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="/firebase.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md p-6">
    <h2 class="text-xl font-bold mb-8">Gestor de Produtos</h2>
    <nav class="space-y-2">
      <a href="dashboard.html" class="block text-gray-600 hover:text-blue-600">Dashboard</a>
      <a href="produtos.html" class="block text-blue-600 font-semibold">Produtos</a>
      <a href="usuarios.html" class="block text-gray-600 hover:text-blue-600">Usuários</a>
      <button id="logoutBtn" class="mt-8 text-red-500 hover:text-red-700">Sair</button>
    </nav>
  </aside>

  <!-- Conteúdo principal -->
  <main class="flex-1 p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">Produtos</h1>
      <button id="addProduto" class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2">
        + Novo Produto
      </button>
    </div>

    <!-- Filtros e Pesquisa -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar por Nome</label>
          <input type="text" id="pesquisaNome" placeholder="Digite o nome do produto..." 
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Pesquisar por SKU</label>
          <input type="text" id="pesquisaSku" placeholder="Digite o SKU..." 
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoria</label>
          <select id="filtroCategoria" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Todas as categorias</option>
            <option value="Eletrônicos">Eletrônicos</option>
            <option value="Móveis">Móveis</option>
            <option value="Limpeza">Limpeza</option>
            <option value="Higiene">Higiene</option>
            <option value="Alimento">Alimento</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Congelados">Congelados</option>
            <option value="Saúde">Saúde</option>
            <option value="Utilidades">Utilidades</option>
            <option value="Infantil">Infantil</option>
          </select>
        </div>
      </div>
      <div class="flex justify-between">
        <button id="limparFiltros" class="bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-4 py-2">
          Limpar Filtros
        </button>
        <div id="resultadosInfo" class="text-sm text-gray-600"></div>
      </div>
    </div>

    <table class="w-full text-left bg-white rounded-xl shadow">
      <thead>
        <tr class="border-b">
          <th class="p-3">Produto</th>
          <th class="p-3">SKU</th>
          <th class="p-3">Categoria</th>
          <th class="p-3">Preço</th>
          <th class="p-3">Estoque</th>
          <th class="p-3">Vencimento</th>
          <th class="p-3">Ações</th>
        </tr>
      </thead>
      <tbody id="listaProdutos"></tbody>
    </table>
  </main>

  <!-- Modal Produto (Usado tanto para Cadastro quanto Edição) -->
  <div id="modalProduto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg max-w-md w-full mx-4">
      <h2 id="modalTitulo" class="text-xl font-semibold mb-4">Cadastrar Novo Produto</h2>
      
      <form id="produtoForm" class="space-y-4">
        <input type="hidden" id="produtoId">
        <input id="nome" type="text" placeholder="Nome do Produto" class="w-full border p-2 rounded" required>
        <input id="sku" type="text" placeholder="SKU" class="w-full border p-2 rounded" required>
        <select id="categoria" class="w-full border p-2 rounded" required>
          <option value="">Selecione a Categoria</option>
          <option value="Eletrônicos">Eletrônicos</option>
          <option value="Móveis">Móveis</option>
          <option value="Limpeza">Limpeza</option>
          <option value="Higiene">Higiene</option>
          <option value="Alimento">Alimento</option>
          <option value="Bebidas">Bebidas</option>
          <option value="Congelados">Congelados</option>
          <option value="Saúde">Saúde</option>
          <option value="Utilidades">Utilidades</option>
          <option value="Infantil">Infantil</option>
        </select>
        <input id="preco" type="number" step="0.01" placeholder="Preço" class="w-full border p-2 rounded" required>
        <input id="estoque" type="number" placeholder="Quantidade em estoque" class="w-full border p-2 rounded" required>
        
        <!-- Campo de Data de Vencimento (aparece apenas para categorias perecíveis) -->
        <div id="vencimentoContainer" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
          <input id="dataVencimento" type="date" class="w-full border p-2 rounded">
        </div>

        <div class="flex justify-between mt-4">
          <button type="button" id="fecharModal"
            class="bg-gray-400 hover:bg-gray-500 text-white rounded-xl px-4 py-2">
            Cancelar
          </button>
          <button type="submit" id="submitButton"
            class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl px-4 py-2">
            Salvar Produto
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const produtoForm = document.getElementById("produtoForm");
const produtoIdInput = document.getElementById("produtoId");
const modalProduto = document.getElementById("modalProduto");
const modalTitulo = document.getElementById("modalTitulo");
const logoutBtn = document.getElementById("logoutBtn");
const listaProdutos = document.getElementById("listaProdutos");

const openFeedback = document.getElementById("openFeedback");
const modalFeedback = document.getElementById("modalFeedback");
const closeFeedback = document.getElementById("closeFeedback");
const sendFeedback = document.getElementById("sendFeedback");
const fbNome = document.getElementById("fb_nome");
const fbTexto = document.getElementById("fb_texto");
const msgFb = document.getElementById("msgFb");

const regexNome = /^[A-Za-zÀ-ÖØ-öø-ÿ ]+$/u;
const sanitize = s => String(s||"").replace(/<[^>]*>?/gm, '').trim();

let editando = false;
let produtos = [];

if (logoutBtn) logoutBtn.addEventListener("click", () => signOut(auth).then(() => (window.location = "index.html")));

if (typeof onAuthStateChanged === "function") {
  onAuthStateChanged(auth, async (user) => {
    if (!user) return (window.location = "index.html");
    await carregarProdutos();
  });
}

async function carregarProdutos() {
  listaProdutos.innerHTML = "";
  produtos = [];
  try {
    const snap = await getDocs(collection(db, "produtos"));
    snap.forEach(d => {
      produtos.push({ id: d.id, ...d.data() });
    });
  } catch (err) {
    console.error("Erro ao buscar produtos:", err);
    alert("Erro ao carregar produtos.");
    return;
  }

  if (!produtos.length) {
    listaProdutos.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">Nenhum produto cadastrado.</td></tr>`;
    return;
  }

// Montar as linhas da tabela com os produtos
  listaProdutos.innerHTML = produtos.map(produto => {
    const statusEstoque = produto.estoque <= 0 ? "text-red-600" : produto.estoque <= 5 ? "text-yellow-600" : "";
    const venc = produto.dataVencimento ? produto.dataVencimento : "";
    const precoStr = (typeof produto.preco === "number") ? produto.preco.toFixed(2) : produto.preco;
    return `
      <tr class="border-b hover:bg-gray-50">
        <td class="p-3">${produto.nome}</td>
        <td class="p-3">${produto.sku}</td>
        <td class="p-3">${produto.categoria}</td>
        <td class="p-3">R$ ${precoStr}</td>
        <td class="p-3 ${statusEstoque}">${produto.estoque}</td>
        <td class="p-3">${venc ? new Date(venc).toLocaleDateString() : "-"}</td>
        <td class="p-3 text-sm">
          <button onclick="editarProduto('${produto.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded px-3 py-1 text-sm mr-2">Editar</button>
          <button onclick="excluirProduto('${produto.id}')" class="bg-red-500 hover:bg-red-600 text-white rounded px-3 py-1 text-sm">Excluir</button>
        </td>
      </tr>`;
  }).join("");
}

/* abrir modal para novo produto */
window.abrirModalProduto = function() {
  editando = false;
  produtoIdInput.value = "";
  produtoForm.reset();
  modalTitulo.textContent = "Cadastrar Novo Produto";
  modalProduto.classList.remove("hidden");
};

/* fechar modal */
window.fecharModalProduto = function() {
  modalProduto.classList.add("hidden");
  produtoForm.reset();
};

/* editar */
window.editarProduto = async function(id) {
  try {
    const snap = await getDoc(doc(db, "produtos", id));
    if (!snap.exists()) { alert("Produto não encontrado"); return; }
    const p = snap.data();
    document.getElementById("produtoId").value = id;
    document.getElementById("nome").value = p.nome ?? "";
    document.getElementById("sku").value = p.sku ?? "";
    document.getElementById("categoria").value = p.categoria ?? "";
    document.getElementById("preco").value = p.preco ?? "";
    document.getElementById("estoque").value = p.estoque ?? "";
    document.getElementById("dataVencimento") && (document.getElementById("dataVencimento").value = p.dataVencimento ?? "");
    editando = true;
    modalTitulo.textContent = "Editar Produto";
    modalProduto.classList.remove("hidden");
  } catch (err) {
    console.error(err);
    alert("Erro ao abrir edição do produto.");
  }
};

/* excluir */
window.excluirProduto = async function(id) {
  if (!confirm("Tem certeza que deseja excluir este produto?")) return;
  try {
    await deleteDoc(doc(db, "produtos", id));
    alert("Produto excluído com sucesso!");
    await carregarProdutos();
  } catch (err) {
    console.error(err);
    alert("Erro ao excluir produto.");
  }
};

/* validação do formulário */
if (produtoForm) {
  produtoForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = document.getElementById("produtoId")?.value || "";
    const rawNome = document.getElementById("nome")?.value ?? "";
    const rawSku = document.getElementById("sku")?.value ?? "";
    const rawCategoria = document.getElementById("categoria")?.value ?? "";
    const rawPreco = document.getElementById("preco")?.value ?? "";
    const rawEstoque = document.getElementById("estoque")?.value ?? "";
    const rawVenc = document.getElementById("dataVencimento") ? document.getElementById("dataVencimento").value : null;

    const nome = sanitize(rawNome);
    if (!nome || nome.length < 3) { alert("Nome obrigatório (mín. 3 caracteres)."); return; }
    if (nome.length > 50) { alert("Nome muito longo (máx. 50)."); return; }
    if (!regexNome.test(nome)) { alert("Nome inválido. Use apenas letras e espaços."); return; }

    const sku = sanitize(rawSku);
    if (!sku || sku.length > 30) { alert("SKU inválido."); return; }

    const categoria = sanitize(rawCategoria);
    if (!categoria) { alert("Categoria inválida."); return; }

    const precoStr = String(rawPreco).trim();
    const precoNum = Number(precoStr.replace(",", "."));
    if (precoStr === "" || Number.isNaN(precoNum)) { alert("Preço inválido."); return; }
    if (precoNum < 0) { alert("Preço não pode ser negativo."); return; }
    if (precoStr.length > 12) { alert("Preço muito longo."); return; }

    const estoqueNum = Number(String(rawEstoque).trim());
    if (!Number.isInteger(estoqueNum) || estoqueNum < 0) { alert("Quantidade inválida (inteiro ≥ 0)."); return; }
    if (String(Math.abs(estoqueNum)).length > 7) { alert("Quantidade muito grande."); return; }

    const dadosProduto = {
      nome,
      sku,
      categoria,
      preco: Number(precoNum.toFixed(2)),
      estoque: estoqueNum,
      dataCadastro: new Date().toISOString()
    };
    if (rawVenc && rawVenc.length) dadosProduto.dataVencimento = rawVenc;
    else dadosProduto.dataVencimento = null;

    try {
      if (editando && id) {
        await updateDoc(doc(db, "produtos", id), dadosProduto);
        alert("Produto atualizado com sucesso!");
      } else {
        await addDoc(collection(db, "produtos"), dadosProduto);
        alert("Produto cadastrado com sucesso!");
      }
      fecharModalProduto();
      carregarProdutos();
    } catch (err) {
      console.error(err);
      alert("Erro ao salvar produto.");
    }
  });
// evita rolagem acidental em números
  document.querySelectorAll('#modalProduto input[type="number"]').forEach(i => i.addEventListener('wheel', e => e.target.blur()));
}


</script>


